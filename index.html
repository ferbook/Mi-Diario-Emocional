!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Diario Emocional</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div id="contenedor"></div>
  <canvas id="graficaEmociones" style="max-width: 700px; margin-top: 20px;"></canvas>

  <script>
    function cargarDatos() {
      const datos = JSON.parse(localStorage.getItem("diario_emocional")) || {};
      const contenedor = document.getElementById("contenedor");

      const fechaInicio = new Date("2025-06-01");
      const fechaHoy = new Date();

      const resumenEmociones = {};
      const emocionesTotales = {};

      Object.keys(datos).forEach(fecha => {
        const fechaData = new Date(fecha);
        if (fechaData >= fechaInicio && fechaData <= fechaHoy) {
          const entrada = datos[fecha];
          const emocion = entrada[0];

          // Mostrar los datos en el contenedor
          const titulo = document.createElement("h3");
          titulo.textContent = `📅 ${fecha}`;
          contenedor.appendChild(titulo);

          entrada.forEach(texto => {
            const p = document.createElement("p");
            p.textContent = texto;
            contenedor.appendChild(p);
          });

          // Registrar emoción para resumen
          resumenEmociones[fecha] = emocion;
          emocionesTotales[emocion] = (emocionesTotales[emocion] || 0) + 1;
        }
      });

      // Crear gráfico
      const ctx = document.getElementById('graficaEmociones').getContext('2d');
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: Object.keys(emocionesTotales),
          datasets: [{
            label: 'Frecuencia de emociones (junio hasta hoy)',
            data: Object.values(emocionesTotales),
            backgroundColor: ['#4caf50', '#2196f3', '#ff9800', '#f44336', '#9c27b0'],
            borderRadius: 5
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            title: {
              display: true,
              text: 'Resumen emocional desde el 1 de junio'
            }
          }
        }
      });

      // Días destacados
      const emocionesClave = ["Feliz", "Triste", "Irritado", "Paciente"];
      const resumenPorEmocion = {};

      emocionesClave.forEach(emocion => {
        resumenPorEmocion[emocion] = Object.entries(resumenEmociones)
          .filter(([_, emo]) => emo === emocion)
          .map(([fecha]) => fecha);
      });

      const resumen = document.createElement("div");
      resumen.innerHTML = `<h2>📊 Días más destacados:</h2>`;
      emocionesClave.forEach(emocion => {
        if (resumenPorEmocion[emocion].length > 0) {
          resumen.innerHTML += `<p>🟢 Día(s) más ${emocion.toLowerCase()}: <strong>${resumenPorEmocion[emocion].join(', ')}</strong></p>`;
        }
      });
      contenedor.appendChild(resumen);

      // Interpretación emocional
      const emocionDominante = Object.entries(emocionesTotales)
        .sort((a, b) => b[1] - a[1])[0]?.[0];

      const interpretacion = {
        "Feliz": "Tu estado emocional más predominante ha sido la **felicidad**. A pesar de los desafíos, estás logrando mantener una perspectiva positiva.",
        "Triste": "La **tristeza** ha sido frecuente en este periodo. Esto puede indicar un proceso interno profundo. Date permiso para sentir y busca apoyo si lo necesitas.",
        "Irritado": "Has mostrado mucha **irritabilidad**. Tal vez estás atravesando estrés o situaciones que te están sobrecargando. Es momento de poner límites y cuidarte.",
        "Paciente": "La **paciencia** ha sido tu fuerza. Has logrado mantener la calma y responder con serenidad ante los retos. Eso es un signo de crecimiento emocional.",
        "Ansioso": "La **ansiedad** ha sido constante. Considera hacer pausas, respirar más conscientemente y hablar con alguien de confianza o un profesional."
      };

      if (emocionDominante) {
        const interpretacionDiv = document.createElement("div");
        interpretacionDiv.innerHTML = `
          <h2>🧠 Interpretación emocional</h2>
          <p>${interpretacion[emocionDominante] || "Se detectó una emoción no clasificada. Observa tus registros y trata de nombrarla con más claridad en el futuro."}</p>
        `;
        contenedor.appendChild(interpretacionDiv);
      }

      // Guardar PDF con todo
      setTimeout(() => {
        const opciones = {
          margin: 0.5,
          filename: `diario_emocional_${new Date().toLocaleDateString().replace(/\//g, '-')}.pdf`,
          image: { type: 'jpeg', quality: 0.98 },
          html2canvas: { scale: 2 },
          jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
        };
        html2pdf().set(opciones).from(document.body).save();
      }, 1500);
    }

    cargarDatos();
  </script>
</body>
</html>
